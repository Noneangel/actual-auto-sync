services:
  # Mock SimpleFIN Server
  # Provides a fake SimpleFIN API for testing bank sync functionality
  mock-simplefin:
    build:
      context: .
      dockerfile: Dockerfile.mock-simplefin
    ports:
      - '8080:8080'
    environment:
      - MOCK_SIMPLEFIN_PORT=8080
      - MOCK_SIMPLEFIN_USERNAME=test
      - MOCK_SIMPLEFIN_PASSWORD=test123
    healthcheck:
      test:
        [
          'CMD',
          'node',
          '-e',
          "fetch('http://localhost:8080/health').then(r => process.exit(r.ok ? 0 : 1)).catch(() => process.exit(1))",
        ]
      interval: 5s
      timeout: 5s
      retries: 3
      start_period: 5s
    restart: 'no'

  actual-server:
    image: actualbudget/actual-server:latest
    ports:
      - '5006:5006'
    volumes:
      - actual-data:/data
    healthcheck:
      test: ['CMD-SHELL', 'node src/scripts/health-check.js']
      interval: 5s
      timeout: 10s
      retries: 12
      start_period: 15s
    restart: 'no'
    depends_on:
      mock-simplefin:
        condition: service_healthy

  e2e-tests:
    build:
      context: .
      dockerfile: Dockerfile.e2e
    user: '${E2E_UID:-1000}:${E2E_GID:-1000}'
    depends_on:
      actual-server:
        condition: service_healthy
      mock-simplefin:
        condition: service_healthy
    read_only: true
    tmpfs:
      - /data:size=256m,mode=0700,uid=${E2E_UID:-1000},gid=${E2E_GID:-1000}
      - /tmp:size=128m,mode=1777,uid=${E2E_UID:-1000},gid=${E2E_GID:-1000}
      - /app/node_modules/.vite-temp:size=64m,mode=0700,uid=${E2E_UID:-1000},gid=${E2E_GID:-1000}
    environment:
      - ACTUAL_SERVER_URL=http://actual-server:5006
      - ACTUAL_SERVER_PASSWORD=test-password-e2e
      - E2E_DATA_DIR=/data
      - E2E_EXPECT_UID=${E2E_UID:-1000}
      - E2E_EXPECT_GID=${E2E_GID:-1000}
      - HOME=/tmp
      - XDG_CACHE_HOME=/tmp/.cache
      - COREPACK_HOME=/tmp/.cache/node/corepack
      # Mock SimpleFIN config (for mock server tests)
      - MOCK_SIMPLEFIN_PORT=8080
      - MOCK_SIMPLEFIN_URL=http://mock-simplefin:8080
      - MOCK_SIMPLEFIN_ACCESS_KEY=http://test:test123@mock-simplefin:8080/
      # Real SimpleFIN tokens (for multi-budget tests with beta-bridge.simplefin.org)
      # SIMPLEFIN_SETUP_TOKEN: Base64-encoded claim URL (e.g., aHR0cHM6Ly9iZXRh...)
      #   - One-time use token that must be claimed to get an access key
      #   - Obtained from SimpleFIN developer portal
      # SIMPLEFIN_ACCESS_KEY: Pre-claimed access URL with embedded credentials
      #   - Format: https://username:password@bridge.simplefin.org/simplefin/
      #   - Use this if token was already claimed
      - SIMPLEFIN_SETUP_TOKEN_1=${SIMPLEFIN_SETUP_TOKEN_1:-}
      - SIMPLEFIN_SETUP_TOKEN_2=${SIMPLEFIN_SETUP_TOKEN_2:-}
      - SIMPLEFIN_ACCESS_KEY_1=${SIMPLEFIN_ACCESS_KEY_1:-}
      - SIMPLEFIN_ACCESS_KEY_2=${SIMPLEFIN_ACCESS_KEY_2:-}

volumes:
  actual-data:
